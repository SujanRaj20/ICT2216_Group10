{% include "buyer-templates/buyer-navbar.html" %} {% block title %}OTP
Verification{% endblock %}

<!-- OTP Verification Page Start -->
<div class="container-fluid page-header py-4">
  <h1 class="text-center text-white display-6">OTP Verification</h1>
</div>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="bg-light rounded p-4">
        <form id="otpForm">
          <div class="mb-3">
            <label for="otp" class="form-label">Enter OTP</label>
            <input
              type="text"
              class="form-control"
              id="otp"
              name="otp"
              required
            />
          </div>
          <div class="mb-3">
            <button type="submit" class="btn btn-primary w-100">
              Verify OTP
            </button>
          </div>
          <div class="mb-3">
            <p>Time left: <span id="timeLeft">60</span> seconds</p>
          </div>
          <div class="mb-3">
            <button
              type="button"
              class="btn btn-secondary w-100"
              id="fetchNewOtp"
            >
              Fetch New OTP
            </button>
          </div>
          {% with messages = get_flashed_messages() %} {% if messages %}
          <div class="alert alert-danger" role="alert">{{ messages[0] }}</div>
          {% endif %} {% endwith %}
        </form>
      </div>
    </div>
  </div>
</div>
<!-- OTP Verification Page End -->

{% include "buyer-templates/buyer-footer.html" %}

<script>
  const purpose = "{{ purpose }}"; // store the purpose of the OTP verification ie. signup or login
  console.log(purpose); // Uncomment this line to log the purpose to the console for debugging

  document
    .getElementById("otpForm")
    .addEventListener("submit", function (event) {
      // Listen for form submission
      event.preventDefault(); // Prevent default form submission
      const otp = sanitize(document.getElementById("otp").value); // Get the value of the OTP input field

      if (!otp) {
        // Check if the OTP is empty
        alert("Please fill in the OTP."); // Alert the user to fill in the OTP
        return;
      }

      if (purpose === "signup") {
        // Check if the purpose is signup
        fetch("/signup_verify_otp", {
          // Fetch the signup_verify_otp route
          method: "POST", // Use the POST method
          headers: {
            "Content-Type": "application/json", // Set the content type to JSON
          },
          body: JSON.stringify(otp), // Send the OTP as JSON
        })
          .then((response) => response.json()) // Parse the response as JSON
          .then((data) => {
            // Handle the response data
            if (data.redirect_url) {
              // Check if the redirect_url is present in the response data
              alert("Signed up successfully."); // Alert the user that they have signed up successfully
              window.location.href = data.redirect_url; // Redirect the user to the redirect_url
            } else {
              // If the redirect_url is not present
              alert(data.error); // Alert the user with the error message
            }
          })
          .catch((error) => {
            // Catch any errors
            console.error("Catch Error:", error); // Log the error to the console
          });
      } else if (purpose === "login") {
        // Check if the purpose is login
        fetch("/login_verify_otp", {
          // Fetch the login_verify_otp route
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(otp),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.redirect_url) {
              alert("Logged in successfully."); // Alert the user that they have logged in successfully
              window.location.href = data.redirect_url; // Redirect the user to the redirect_url
            } else {
              alert(data.error);
            }
          })
          .catch((error) => {
            console.error("Catch Error:", error);
          });
      }
    });

  let timeLeft = 60; // Set the time left to 60 seconds
  let alertShown = false; // Set the alertShown flag to false
  const timeLeftElement = document.getElementById("timeLeft"); // Get the timeLeft element
  const fetchNewOtpButton = document.getElementById("fetchNewOtp"); // Get the fetchNewOtp button

  function updateTimeLeft() {
    // Function to update the time left
    if (timeLeft > 0) {
      // Check if the time left is greater than 0
      timeLeft -= 1; // Decrement the time left by 1
      timeLeftElement.textContent = timeLeft; // Update the timeLeft element with the new time left
    } else {
      // If the time left is 0
      clearInterval(timerInterval); // Clear the timer interval
      fetchNewOtpButton.disabled = false; // Enable the fetchNewOtp button
      if (!alertShown) {
        // Check if the alert has not been shown
        alert("OTP has expired. Please request a new one."); // Alert the user that the OTP has expired
        alertShown = true; // Set the alertShown flag to true
      }
    }
  }

  const timerInterval = setInterval(updateTimeLeft, 1000); // Set the timer interval to update the time left every second

  fetchNewOtpButton.addEventListener("click", function () {
    // Listen for the click event on the fetchNewOtp button
    fetch("/generate_new_otp", {
      // Fetch the generate_new_otp route
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.message) {
          alert(data.message);
          timeLeft = 60; // Reset the timer
          fetchNewOtpButton.disabled = true;
          alertShown = false; // Reset the alert flag
          clearInterval(timerInterval);
          setInterval(updateTimeLeft, 1000);
        } else {
          alert(data.error);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while fetching a new OTP.");
      });
  });

  function sanitize(input) {
    // Function to sanitize the input
    const element = document.createElement("div"); // Create a new div element
    element.innerText = input; // Set the inner text of the div element to the input
    return element.innerHTML; // Return the inner HTML of the div element
  }
</script>
