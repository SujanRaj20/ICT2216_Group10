{% include "buyer-templates/buyer-navbar.html" %} {% block title %}Home{% endblock %}
<!-- Single Page Header start -->
<div class="container-fluid page-header py-4">
  <h1 class="text-center text-white display-6">Login</h1>
</div>
<!-- Single Page Header End -->
<!-- Log In Start -->
<div class="container-fluid testimonial py-1">
  <div class="container py-5">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="bg-light rounded p-4">
            <form id="loginForm" method="POST" action="/buyerlogin">
              <!-- Input fields for email and password -->
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  name="password"
                  required
                />
              </div>
              <div class="mb-3">
                <img src="/generate_captcha" alt="CAPTCHA" id="captcha_image" />
                <input
                  type="text"
                  class="form-control"
                  id="captcha"
                  name="captcha"
                  placeholder="Enter CAPTCHA"
                  required
                />
              </div>
              <div class="mb-3">
                <button
                  type="button"
                  id="refresh_captcha"
                  class="btn btn-secondary"
                >
                  Refresh CAPTCHA
                </button>
              </div>
              <div class="mb-3">
                <button type="submit" class="btn btn-primary w-100">
                  Login
                </button>
              </div>
              <div class="mb-3">
                <a href="{{ url_for('main.signup') }}" class="nav-item nav-link"
                  >No account? Sign up here</a
                >
              </div>
              <div class="mb-3">
                <a
                  href="{{ url_for('main.seller_signup') }}"
                  class="nav-item nav-link"
                  >Want to create a Seller account? Sign up here</a
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Testimonial End -->
{% include "buyer-templates/buyer-footer.html" %}

<script>
  document
    .getElementById("refresh_captcha")
    .addEventListener("click", function () {
      document.getElementById("captcha_image").src =
        "/generate_captcha?" + Date.now();
    });

  document
    .getElementById("loginForm")
    .addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent default form submission


      const email = sanitize(document.getElementById("email").value);
      const password = sanitize(document.getElementById("password").value);
      const captcha = sanitize(document.getElementById("captcha").value);

      const userData = {
        email,
        password,
        captcha,
      };

      fetch("/buyerlogin", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(userData),
      })
        .then((response) => {
          return response.text().then((text) => {
            try {
              const data = JSON.parse(text);
              return {
                status: response.status,
                body: data,
              };
            } catch (error) {
              return {
                status: response.status,
                body: { error: text },
              };
            }
          });
        })
        .then((data) => {
          if (data.status === 200) {
            // Clear the form fields
            document.getElementById("loginForm").reset();
            // Redirect to the otp page
            window.location.href = data.body.redirect_url || "verify_otp";
          } else {
            // Handle invalid CAPTCHA or other errors
            alert(data.body.error);
            document.getElementById("captcha_image").src =
              "/generate_captcha?" + Date.now();
            document.getElementById("captcha").value = "";
            if (data.body.error !== "Invalid CAPTCHA. Please try again.") {
              document.getElementById("email").value = "";
              document.getElementById("password").value = "";
            }
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred: " + error.message);
          document.getElementById("captcha_image").src =
            "/generate_captcha?" + Date.now();
          document.getElementById("captcha").value = "";
          document.getElementById("email").value = "";
          document.getElementById("password").value = "";
        });
    });

    function sanitize(input) {
      const element = document.createElement("div");
      element.innerText = input;
      return element.innerHTML;
    }
</script>
